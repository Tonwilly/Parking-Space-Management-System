<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Create Admin</title>
    <style>
        body {
            background: #dcf0de;
            font-family: sans-serif;
            padding: 2rem;
        }
        .box {
            background: #fff;
            max-width: 450px;
            margin: auto;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        input {
            width: 100%;
            padding: .7rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            border: 1px solid #ccc;
        }
        button {
            width: 100%;
            padding: .8rem;
            border: none;
            border-radius: 6px;
            background: #2b7a78;
            color: white;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="box">
    <h2>Create Admin User</h2>

    <input id="adminName" type="text" placeholder="Full Name" autocomplete="off">
    <input id="adminEmail" type="email" placeholder="Admin Email" autocomplete="off">
    <input id="adminPassword" type="password" placeholder="Password" autocomplete="off">

    <button id="createAdminBtn">Create Admin</button>

    <p id="msg"></p>
</div>

<script type="module">
    import { auth, db, app } from "./js/firebase-config.js";
    import { createUserWithEmailAndPassword, getAuth } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
    import { onAuthStateChanged,signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";

    const msg = document.getElementById("msg");

    const MASTER_ADMIN_UID = "VwVa8tOca9PlE8xpAyVbxyTeEP53";
    

    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "login.html";
            return;
        }

        if (user.uid !== MASTER_ADMIN_UID) {
            alert("Access denied. Master admin only.");
            await signOut(auth);
            window.location.href = "login.html";
            return;
        }

        const snap = await getDoc(doc(db, "users", user.uid));
        if (!snap.exists() || snap.data().role !== "admin") {
            alert("Invalid admin account.");
            await signOut(auth);
            window.location.href = "login.html";
        }
    });

    // Only allow existing admin to open this page
   /* onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "login.html";
            return;
        }

        const snap = await import("https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js")
            .then(fire => fire.getDoc(fire.doc(db, "users", user.uid)));

        if (!snap.exists() || snap.data().role !== "admin") {
            alert("Access denied. Only Admins can create other Admins.");
            window.location.href = "index.html";
        }
    });*/

    document.getElementById("createAdminBtn").addEventListener("click", async () => {
        const name = adminName.value.trim();
        const email = adminEmail.value.trim();
        const password = adminPassword.value;

        if (!name || !email || !password) {
            msg.textContent = "All fields are required.";
            msg.style.color = "red";
            return;
        }

        try {
            // create a secondary app instance to avoid affecting the current logged-in user
            const secondaryApp = initializeApp(app.options, "Secondary");
            const secondaryAuth = getAuth(secondaryApp);

            const credential = await createUserWithEmailAndPassword(secondaryAuth, email, password);
            const uid = credential.user.uid;

            await setDoc(doc(db, "users", uid), {
                name,
                email,
                role: "admin",
                createdAt: new Date()
            });

            msg.textContent = "Admin created successfully!";
            msg.style.color = "green";

            // Clean up
            await signOut(secondaryAuth);

            adminName.value = "";
            adminEmail.value = "";
            adminPassword.value = "";
        } catch (err) {
            console.error(err);
            msg.textContent = err.message;
            msg.style.color = "red";
        }
    });
</script>

</body>
</html>
